name: Tests

on:
  push:
    branches: [main]
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      run_mode:
        description: 'Execution Mode'
        required: false
        default: basic
        type: choice
        options:
          - basic
          - safe
          - stress
      threads:
        description: 'Threads'
        required: false
        default: '4'
        type: string
      test_env:
        description: 'Environment'
        required: false
        default: DEV
        type: choice
        options:
          - DEV
          - QA
          - PROD
      safe_pause_seconds:
        description: 'Rest per test batch (seconds)'
        required: false
        default: '30'
        type: string
      tags:
        description: 'Run specific TAGS (e.g. PHARMA-67)'
        required: false
        default: ''
        type: string

permissions:
  contents: write

env:
  ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
  ADMIN_USERNAME: ${{ secrets.ADMIN_USERNAME }}
  API_BASE_LEGACY: ${{ secrets.API_BASE_LEGACY }}
  API_BASE_URL: ${{ secrets.API_BASE_URL }}
  BASE_URL_DEV: ${{ secrets.BASE_URL_DEV }}
  DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
  DEV_TESTING_CHANNELID: ${{ secrets.DEV_TESTING_CHANNELID }}
  QA_TESTING_CHANNELID: ${{ secrets.QA_TESTING_CHANNELID }}
  PROD_TESTING_CHANNELID: ${{ secrets.PROD_TESTING_CHANNELID }}
  LOCAL_RUNS_CHANNELID: ${{ secrets.LOCAL_RUNS_CHANNELID }}
  GITHUB_TOKEN: ${{ github.token }}
  GIT_AUTHOR_NAME: github-actions[bot]
  GIT_AUTHOR_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
  GIT_COMMITTER_NAME: github-actions[bot]
  GIT_COMMITTER_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
  GRAPHQL_PATH: ${{ secrets.GRAPHQL_PATH }}
  MERCHANT_PASSWORD: ${{ secrets.MERCHANT_PASSWORD }}
  MERCHANT_USERNAME: ${{ secrets.MERCHANT_USERNAME }}
  PATIENT_USER_PASSWORD: ${{ secrets.PATIENT_USER_PASSWORD }}
  PATIENT_USER_USERNAME: ${{ secrets.PATIENT_USER_USERNAME }}
  PATIENT_USER_USERNAME_ID: ${{ secrets.PATIENT_USER_USERNAME_ID }}
  PATIENT_USER_USERNAME_RELATED_ID: ${{ secrets.PATIENT_USER_USERNAME_RELATED_ID }}
  PHARMACIST_BRANCHID_REG01: ${{ secrets.PHARMACIST_BRANCHID_REG01 }}
  PHARMACIST_BRANCHID_REG02: ${{ secrets.PHARMACIST_BRANCHID_REG02 }}
  PHARMACIST_PASSWORD_ADMIN: ${{ secrets.PHARMACIST_PASSWORD_ADMIN }}
  PHARMACIST_PASSWORD_PSE01: ${{ secrets.PHARMACIST_PASSWORD_PSE01 }}
  PHARMACIST_PASSWORD_REG01: ${{ secrets.PHARMACIST_PASSWORD_REG01 }}
  PHARMACIST_PASSWORD_REG02: ${{ secrets.PHARMACIST_PASSWORD_REG02 }}
  PHARMACIST_PHONENUMBER_REG01: ${{ secrets.PHARMACIST_PHONENUMBER_REG01 }}
  PHARMACIST_PHONENUMBER_REG02: ${{ secrets.PHARMACIST_PHONENUMBER_REG02 }}
  PHARMACIST_REUSABLE_ORDERID_REG01: ${{ secrets.PHARMACIST_REUSABLE_ORDERID_REG01 }}
  PHARMACIST_USERNAME_ADMIN: ${{ secrets.PHARMACIST_USERNAME_ADMIN }}
  PHARMACIST_USERNAME_PSE01: ${{ secrets.PHARMACIST_USERNAME_PSE01 }}
  PHARMACIST_USERNAME_REG01: ${{ secrets.PHARMACIST_USERNAME_REG01 }}
  PHARMACIST_USERNAME_REG02: ${{ secrets.PHARMACIST_USERNAME_REG02 }}
  REPORT_PUBLISH: '1'
  RIDER_PASSWORD: ${{ secrets.RIDER_PASSWORD }}
  RIDER_USERID: ${{ secrets.RIDER_USERID }}
  RIDER_USERNAME: ${{ secrets.RIDER_USERNAME }}
  TAGS: ${{ secrets.TAGS }}
  TEST_ENV: ${{ secrets.TEST_ENV }}
  THREADS: ${{ secrets.THREADS }}
  CI: true

concurrency:
  # Manual runs should not cancel each other; auto runs should cancel older same-ref runs.
  group: ${{ github.event_name == 'workflow_dispatch' && format('tests-manual-{0}', github.run_id) || format('tests-{0}', github.ref) }}
  cancel-in-progress: ${{ github.event_name != 'workflow_dispatch' }}

jobs:
  api-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: Configure git identity for report publish
        run: |
          git config --global user.name "${GIT_COMMITTER_NAME}"
          git config --global user.email "${GIT_COMMITTER_EMAIL}"
      - run: npm ci
      - run: npx playwright install --with-deps
      - name: Resolve run selector
        id: selector
        shell: bash
        run: |
          MODE="safe"
          EVENT_NAME="${{ github.event_name }}"
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            MODE="${{ inputs.run_mode }}"
          fi

          RUN_THREADS="${THREADS:-4}"
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ inputs.threads }}" ]]; then
            RUN_THREADS="${{ inputs.threads }}"
          fi

          RUN_TEST_ENV="${TEST_ENV:-DEV}"
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ inputs.test_env }}" ]]; then
            RUN_TEST_ENV="${{ inputs.test_env }}"
          fi

          SAFE_PAUSE="30"
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ inputs.safe_pause_seconds }}" ]]; then
            SAFE_PAUSE="${{ inputs.safe_pause_seconds }}"
          fi

          RUN_TAGS=""
          if [[ "${EVENT_NAME}" == "workflow_dispatch" ]]; then
            RUN_TAGS="${{ inputs.tags }}"
          elif [[ "${EVENT_NAME}" == "push" ]]; then
            RUN_TAGS="smoke"
          elif [[ "${EVENT_NAME}" == "schedule" ]]; then
            RUN_TAGS=""
          fi

          if [[ "${MODE}" == "stress" ]]; then
            RUN_TAGS=""
            SAFE_PAUSE="0"
          fi

          echo "mode=${MODE}" >> "$GITHUB_OUTPUT"
          echo "threads=${RUN_THREADS}" >> "$GITHUB_OUTPUT"
          echo "test_env=${RUN_TEST_ENV}" >> "$GITHUB_OUTPUT"
          echo "safe_pause=${SAFE_PAUSE}" >> "$GITHUB_OUTPUT"
          echo "run_tags=${RUN_TAGS}" >> "$GITHUB_OUTPUT"

      - name: Run tests
        shell: bash
        run: |
          if [[ "${{ steps.selector.outputs.mode }}" == "stress" ]]; then
            echo "Running full suite in STRESS mode"
            TEST_ENV=${{ steps.selector.outputs.test_env }} THREADS=${{ steps.selector.outputs.threads }} npm run test:all:stress
          elif [[ "${{ steps.selector.outputs.mode }}" == "safe" ]]; then
            if [[ "${{ github.event_name }}" == "push" ]]; then
              echo "Running SAFE mode smoke batches (push)"
              TEST_ENV=${{ steps.selector.outputs.test_env }} THREADS=${{ steps.selector.outputs.threads }} SAFE_PAUSE_SECONDS=${{ steps.selector.outputs.safe_pause }} SAFE_TAGS="${{ steps.selector.outputs.run_tags }}" DISCORD_GREP_LABEL=smoke npm run test:all:safe
            elif [[ "${{ github.event_name }}" == "schedule" ]]; then
              echo "Running SAFE mode full batches (schedule)"
              TEST_ENV=${{ steps.selector.outputs.test_env }} THREADS=${{ steps.selector.outputs.threads }} SAFE_PAUSE_SECONDS=${{ steps.selector.outputs.safe_pause }} SAFE_TAGS="__ALL__" npm run test:all:safe
            elif [[ -n "${{ steps.selector.outputs.run_tags }}" ]]; then
              echo "Running SAFE mode with specific TAGS in a single pass"
              TEST_ENV=${{ steps.selector.outputs.test_env }} THREADS=${{ steps.selector.outputs.threads }} TAGS="${{ steps.selector.outputs.run_tags }}" PROJECT=e2e,api npx playwright test
            else
              echo "Running full suite in SAFE mode"
              TEST_ENV=${{ steps.selector.outputs.test_env }} THREADS=${{ steps.selector.outputs.threads }} SAFE_PAUSE_SECONDS=${{ steps.selector.outputs.safe_pause }} SAFE_TAGS="__ALL__" npm run test:all:safe
            fi
          else
            if [[ -n "${{ steps.selector.outputs.run_tags }}" ]]; then
              echo "Running BASIC mode with specific TAGS"
              TEST_ENV=${{ steps.selector.outputs.test_env }} THREADS=${{ steps.selector.outputs.threads }} TAGS="${{ steps.selector.outputs.run_tags }}" PROJECT=e2e,api npx playwright test
            else
              echo "Running smoke suite in BASIC mode"
              TEST_ENV=${{ steps.selector.outputs.test_env }} THREADS=${{ steps.selector.outputs.threads }} TAGS="smoke" DISCORD_GREP_LABEL=smoke PROJECT= npx playwright test
            fi
          fi

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: .playwright-report
          include-hidden-files: true
