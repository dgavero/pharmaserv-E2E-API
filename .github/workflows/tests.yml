name: Tests

on:
  push:
    branches: [main]
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      run_mode:
        description: 'Execution mode'
        required: false
        default: safe
        type: choice
        options:
          - safe
          - stress
      threads:
        description: 'Worker count override (optional)'
        required: false
        default: '4'
        type: string
      safe_pause_seconds:
        description: 'Pause between SAFE batches in seconds'
        required: false
        default: '30'
        type: string

permissions:
  contents: write

concurrency:
  group: tests-${{ github.ref }}
  cancel-in-progress: true

jobs:
  api-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    env:
      ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
      ADMIN_USERNAME: ${{ secrets.ADMIN_USERNAME }}
      API_BASE_LEGACY: ${{ secrets.API_BASE_LEGACY }}
      API_BASE_URL: ${{ secrets.API_BASE_URL }}
      BASE_URL_DEV: ${{ secrets.BASE_URL_DEV }}
      DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
      DISCORD_CHANNEL_ID: ${{ secrets.DISCORD_CHANNEL_ID }}
      GITHUB_TOKEN: ${{ github.token }}
      GIT_AUTHOR_NAME: github-actions[bot]
      GIT_AUTHOR_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
      GIT_COMMITTER_NAME: github-actions[bot]
      GIT_COMMITTER_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
      GRAPHQL_PATH: ${{ secrets.GRAPHQL_PATH }}
      MERCHANT_PASSWORD: ${{ secrets.MERCHANT_PASSWORD }}
      MERCHANT_USERNAME: ${{ secrets.MERCHANT_USERNAME }}
      PATIENT_USER_PASSWORD: ${{ secrets.PATIENT_USER_PASSWORD }}
      PATIENT_USER_USERNAME: ${{ secrets.PATIENT_USER_USERNAME }}
      PATIENT_USER_USERNAME_ID: ${{ secrets.PATIENT_USER_USERNAME_ID }}
      PATIENT_USER_USERNAME_RELATED_ID: ${{ secrets.PATIENT_USER_USERNAME_RELATED_ID }}
      PHARMACIST_BRANCHID_REG01: ${{ secrets.PHARMACIST_BRANCHID_REG01 }}
      PHARMACIST_BRANCHID_REG02: ${{ secrets.PHARMACIST_BRANCHID_REG02 }}
      PHARMACIST_PASSWORD_ADMIN: ${{ secrets.PHARMACIST_PASSWORD_ADMIN }}
      PHARMACIST_PASSWORD_PSE01: ${{ secrets.PHARMACIST_PASSWORD_PSE01 }}
      PHARMACIST_PASSWORD_REG01: ${{ secrets.PHARMACIST_PASSWORD_REG01 }}
      PHARMACIST_PASSWORD_REG02: ${{ secrets.PHARMACIST_PASSWORD_REG02 }}
      PHARMACIST_PHONENUMBER_REG01: ${{ secrets.PHARMACIST_PHONENUMBER_REG01 }}
      PHARMACIST_PHONENUMBER_REG02: ${{ secrets.PHARMACIST_PHONENUMBER_REG02 }}
      PHARMACIST_REUSABLE_ORDERID_REG01: ${{ secrets.PHARMACIST_REUSABLE_ORDERID_REG01 }}
      PHARMACIST_USERNAME_ADMIN: ${{ secrets.PHARMACIST_USERNAME_ADMIN }}
      PHARMACIST_USERNAME_PSE01: ${{ secrets.PHARMACIST_USERNAME_PSE01 }}
      PHARMACIST_USERNAME_REG01: ${{ secrets.PHARMACIST_USERNAME_REG01 }}
      PHARMACIST_USERNAME_REG02: ${{ secrets.PHARMACIST_USERNAME_REG02 }}
      REPORT_PUBLISH: "1"
      RIDER_PASSWORD: ${{ secrets.RIDER_PASSWORD }}
      RIDER_USERID: ${{ secrets.RIDER_USERID }}
      RIDER_USERNAME: ${{ secrets.RIDER_USERNAME }}
      TAGS: ${{ secrets.TAGS }}
      TEST_ENV: ${{ secrets.TEST_ENV }}
      THREADS: ${{ secrets.THREADS }}
      CI: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: Configure git identity for report publish
        run: |
          git config --global user.name "${GIT_COMMITTER_NAME}"
          git config --global user.email "${GIT_COMMITTER_EMAIL}"
      - run: npm ci
      - run: npx playwright install --with-deps
      - name: Resolve run mode and execution settings
        id: run_config
        shell: bash
        run: |
          MODE="safe"
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            MODE="${{ inputs.run_mode }}"
          fi

          RUN_THREADS="${THREADS:-4}"
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ inputs.threads }}" ]]; then
            RUN_THREADS="${{ inputs.threads }}"
          fi

          SAFE_PAUSE="30"
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ inputs.safe_pause_seconds }}" ]]; then
            SAFE_PAUSE="${{ inputs.safe_pause_seconds }}"
          fi

          echo "mode=${MODE}" >> "$GITHUB_OUTPUT"
          echo "threads=${RUN_THREADS}" >> "$GITHUB_OUTPUT"
          echo "safe_pause=${SAFE_PAUSE}" >> "$GITHUB_OUTPUT"
          echo "Resolved mode=${MODE} threads=${RUN_THREADS} safe_pause=${SAFE_PAUSE}"

      - name: Run tests in SAFE mode (default for push/schedule)
        if: steps.run_config.outputs.mode == 'safe'
        run: |
          THREADS=${{ steps.run_config.outputs.threads }} \
          SAFE_PAUSE_SECONDS=${{ steps.run_config.outputs.safe_pause }} \
          npm run test:all:safe

      - name: Run tests in STRESS mode (manual only)
        if: steps.run_config.outputs.mode == 'stress'
        run: |
          THREADS=${{ steps.run_config.outputs.threads }} \
          npm run test:all:stress
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-playwright-report
          path: .playwright-report
          include-hidden-files: true
