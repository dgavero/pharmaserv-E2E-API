name: Tests

on:
  push:
    branches: [main]
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

concurrency:
  group: tests-${{ github.ref }}
  cancel-in-progress: true

jobs:
  api-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    env:
      ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
      ADMIN_USERNAME: ${{ secrets.ADMIN_USERNAME }}
      API_BASE_LEGACY: ${{ secrets.API_BASE_LEGACY }}
      API_BASE_URL: ${{ secrets.API_BASE_URL }}
      BASE_URL_DEV: ${{ secrets.BASE_URL_DEV }}
      DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
      DISCORD_CHANNEL_ID: ${{ secrets.DISCORD_CHANNEL_ID }}
      DISCORD_LOG_PASSED: ${{ secrets.DISCORD_LOG_PASSED }}
      GRAPHQL_PATH: ${{ secrets.GRAPHQL_PATH }}
      MERCHANT_PASSWORD: ${{ secrets.MERCHANT_PASSWORD }}
      MERCHANT_USERNAME: ${{ secrets.MERCHANT_USERNAME }}
      PATIENT_USER_PASSWORD: ${{ secrets.PATIENT_USER_PASSWORD }}
      PATIENT_USER_USERNAME: ${{ secrets.PATIENT_USER_USERNAME }}
      PATIENT_USER_USERNAME_ID: ${{ secrets.PATIENT_USER_USERNAME_ID }}
      PATIENT_USER_USERNAME_RELATED_ID: ${{ secrets.PATIENT_USER_USERNAME_RELATED_ID }}
      PHARMACIST_BRANCHID_REG01: ${{ secrets.PHARMACIST_BRANCHID_REG01 }}
      PHARMACIST_BRANCHID_REG02: ${{ secrets.PHARMACIST_BRANCHID_REG02 }}
      PHARMACIST_PASSWORD_ADMIN: ${{ secrets.PHARMACIST_PASSWORD_ADMIN }}
      PHARMACIST_PASSWORD_PSE01: ${{ secrets.PHARMACIST_PASSWORD_PSE01 }}
      PHARMACIST_PASSWORD_REG01: ${{ secrets.PHARMACIST_PASSWORD_REG01 }}
      PHARMACIST_PASSWORD_REG02: ${{ secrets.PHARMACIST_PASSWORD_REG02 }}
      PHARMACIST_PHONENUMBER_REG01: ${{ secrets.PHARMACIST_PHONENUMBER_REG01 }}
      PHARMACIST_PHONENUMBER_REG02: ${{ secrets.PHARMACIST_PHONENUMBER_REG02 }}
      PHARMACIST_REUSABLE_ORDERID_REG01: ${{ secrets.PHARMACIST_REUSABLE_ORDERID_REG01 }}
      PHARMACIST_USERNAME_ADMIN: ${{ secrets.PHARMACIST_USERNAME_ADMIN }}
      PHARMACIST_USERNAME_PSE01: ${{ secrets.PHARMACIST_USERNAME_PSE01 }}
      PHARMACIST_USERNAME_REG01: ${{ secrets.PHARMACIST_USERNAME_REG01 }}
      PHARMACIST_USERNAME_REG02: ${{ secrets.PHARMACIST_USERNAME_REG02 }}
      REPORT_PUBLISH: ${{ secrets.REPORT_PUBLISH }}
      RIDER_PASSWORD: ${{ secrets.RIDER_PASSWORD }}
      RIDER_USERID: ${{ secrets.RIDER_USERID }}
      RIDER_USERNAME: ${{ secrets.RIDER_USERNAME }}
      TAGS: ${{ secrets.TAGS }}
      TEST_ENV: ${{ secrets.TEST_ENV }}
      THREADS: ${{ secrets.THREADS }}
      CI: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npx playwright install --with-deps
      - run: npx playwright test api/tests
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-playwright-report
          path: .playwright-report
