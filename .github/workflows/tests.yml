name: Tests

on:
  push:
    branches: [main]
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      run_mode:
        description: 'Execution mode'
        required: false
        default: safe
        type: choice
        options:
          - safe
          - stress
      suite_scope:
        description: 'Suite scope for non-rerun runs'
        required: false
        default: smoke
        type: choice
        options:
          - smoke
          - full
      threads:
        description: 'Worker count override (optional)'
        required: false
        default: '4'
        type: string
      test_env:
        description: 'Target environment'
        required: false
        default: DEV
        type: choice
        options:
          - DEV
          - QA
          - PROD
      safe_pause_seconds:
        description: 'Pause between SAFE batches in seconds'
        required: false
        default: '30'
        type: string
      rerun_project:
        description: 'Project for targeted rerun (used when rerun_tags is set)'
        required: false
        default: all
        type: choice
        options:
          - api
          - e2e
          - all
      rerun_tags:
        description: 'Run specific TAGS (e.g. PHARMA-67)'
        required: false
        default: ''
        type: string

permissions:
  contents: write

env:
  ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
  ADMIN_USERNAME: ${{ secrets.ADMIN_USERNAME }}
  API_BASE_LEGACY: ${{ secrets.API_BASE_LEGACY }}
  API_BASE_URL: ${{ secrets.API_BASE_URL }}
  BASE_URL_DEV: ${{ secrets.BASE_URL_DEV }}
  DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
  DEV_TESTING_CHANNELID: '1407783823835402351'
  QA_TESTING_CHANNELID: '1473873338756632716'
  PROD_TESTING_CHANNELID: '1473873431748677723'
  LOCAL_RUNS_CHANNELID: '1473872105849491629'
  GITHUB_TOKEN: ${{ github.token }}
  GIT_AUTHOR_NAME: github-actions[bot]
  GIT_AUTHOR_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
  GIT_COMMITTER_NAME: github-actions[bot]
  GIT_COMMITTER_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
  GRAPHQL_PATH: ${{ secrets.GRAPHQL_PATH }}
  MERCHANT_PASSWORD: ${{ secrets.MERCHANT_PASSWORD }}
  MERCHANT_USERNAME: ${{ secrets.MERCHANT_USERNAME }}
  PATIENT_USER_PASSWORD: ${{ secrets.PATIENT_USER_PASSWORD }}
  PATIENT_USER_USERNAME: ${{ secrets.PATIENT_USER_USERNAME }}
  PATIENT_USER_USERNAME_ID: ${{ secrets.PATIENT_USER_USERNAME_ID }}
  PATIENT_USER_USERNAME_RELATED_ID: ${{ secrets.PATIENT_USER_USERNAME_RELATED_ID }}
  PHARMACIST_BRANCHID_REG01: ${{ secrets.PHARMACIST_BRANCHID_REG01 }}
  PHARMACIST_BRANCHID_REG02: ${{ secrets.PHARMACIST_BRANCHID_REG02 }}
  PHARMACIST_PASSWORD_ADMIN: ${{ secrets.PHARMACIST_PASSWORD_ADMIN }}
  PHARMACIST_PASSWORD_PSE01: ${{ secrets.PHARMACIST_PASSWORD_PSE01 }}
  PHARMACIST_PASSWORD_REG01: ${{ secrets.PHARMACIST_PASSWORD_REG01 }}
  PHARMACIST_PASSWORD_REG02: ${{ secrets.PHARMACIST_PASSWORD_REG02 }}
  PHARMACIST_PHONENUMBER_REG01: ${{ secrets.PHARMACIST_PHONENUMBER_REG01 }}
  PHARMACIST_PHONENUMBER_REG02: ${{ secrets.PHARMACIST_PHONENUMBER_REG02 }}
  PHARMACIST_REUSABLE_ORDERID_REG01: ${{ secrets.PHARMACIST_REUSABLE_ORDERID_REG01 }}
  PHARMACIST_USERNAME_ADMIN: ${{ secrets.PHARMACIST_USERNAME_ADMIN }}
  PHARMACIST_USERNAME_PSE01: ${{ secrets.PHARMACIST_USERNAME_PSE01 }}
  PHARMACIST_USERNAME_REG01: ${{ secrets.PHARMACIST_USERNAME_REG01 }}
  PHARMACIST_USERNAME_REG02: ${{ secrets.PHARMACIST_USERNAME_REG02 }}
  REPORT_PUBLISH: '1'
  RIDER_PASSWORD: ${{ secrets.RIDER_PASSWORD }}
  RIDER_USERID: ${{ secrets.RIDER_USERID }}
  RIDER_USERNAME: ${{ secrets.RIDER_USERNAME }}
  TAGS: ${{ secrets.TAGS }}
  TEST_ENV: ${{ secrets.TEST_ENV }}
  THREADS: ${{ secrets.THREADS }}
  CI: true

concurrency:
  # Manual runs should not cancel each other; auto runs should cancel older same-ref runs.
  group: ${{ github.event_name == 'workflow_dispatch' && format('tests-manual-{0}', github.run_id) || format('tests-{0}', github.ref) }}
  cancel-in-progress: ${{ github.event_name != 'workflow_dispatch' }}

jobs:
  api-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    env:
      SMOKE_TAGS: PHARMA-1|PHARMA-3|PHARMA-30|PHARMA-59|PHARMA-60|PHARMA-116|PHARMA-118|PHARMA-141|PHARMA-143|PHARMA-150|PHARMA-176|PHARMA-258|PHARMA-261|PHARMA-285|PHARMA-315|PHARMA-334|PHARMA-336|PHARMA-337|E2E-1
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: Configure git identity for report publish
        run: |
          git config --global user.name "${GIT_COMMITTER_NAME}"
          git config --global user.email "${GIT_COMMITTER_EMAIL}"
      - run: npm ci
      - run: npx playwright install --with-deps
      - name: Resolve run selector
        id: selector
        shell: bash
        run: |
          MODE="safe"
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            MODE="${{ inputs.run_mode }}"
          fi

          RUN_THREADS="${THREADS:-4}"
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ inputs.threads }}" ]]; then
            RUN_THREADS="${{ inputs.threads }}"
          fi

          RUN_TEST_ENV="${TEST_ENV:-DEV}"
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ inputs.test_env }}" ]]; then
            RUN_TEST_ENV="${{ inputs.test_env }}"
          fi

          SAFE_PAUSE="30"
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ inputs.safe_pause_seconds }}" ]]; then
            SAFE_PAUSE="${{ inputs.safe_pause_seconds }}"
          fi

          RERUN_TAGS=""
          RERUN_PROJECT="all"
          PROJECT_SELECTOR="e2e,api"
          SUITE_SCOPE="smoke"
          USE_SMOKE="1"
          SAFE_TAGS="${SMOKE_TAGS}"
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            RERUN_TAGS="${{ inputs.rerun_tags }}"
            RERUN_PROJECT="${{ inputs.rerun_project }}"
            SUITE_SCOPE="${{ inputs.suite_scope }}"
            if [[ "${RERUN_PROJECT}" == "all" ]]; then
              PROJECT_SELECTOR="e2e,api"
            else
              PROJECT_SELECTOR="${RERUN_PROJECT}"
            fi
          fi

          if [[ -n "${RERUN_TAGS}" ]]; then
            USE_SMOKE="0"
          elif [[ "${SUITE_SCOPE}" == "full" ]]; then
            USE_SMOKE="0"
            SAFE_TAGS=""
          fi

          echo "mode=${MODE}" >> "$GITHUB_OUTPUT"
          echo "threads=${RUN_THREADS}" >> "$GITHUB_OUTPUT"
          echo "test_env=${RUN_TEST_ENV}" >> "$GITHUB_OUTPUT"
          echo "safe_pause=${SAFE_PAUSE}" >> "$GITHUB_OUTPUT"
          echo "rerun_tags=${RERUN_TAGS}" >> "$GITHUB_OUTPUT"
          echo "project_selector=${PROJECT_SELECTOR}" >> "$GITHUB_OUTPUT"
          echo "use_smoke=${USE_SMOKE}" >> "$GITHUB_OUTPUT"
          echo "safe_tags=${SAFE_TAGS}" >> "$GITHUB_OUTPUT"

      - name: Run tests (full or targeted rerun)
        shell: bash
        run: |
          if [[ -n "${{ steps.selector.outputs.rerun_tags }}" ]]; then
            echo "Running targeted rerun: TAGS=${{ steps.selector.outputs.rerun_tags }} PROJECT=${{ steps.selector.outputs.project_selector }}"
            TEST_ENV=${{ steps.selector.outputs.test_env }} THREADS=${{ steps.selector.outputs.threads }} TAGS="${{ steps.selector.outputs.rerun_tags }}" PROJECT=${{ steps.selector.outputs.project_selector }} npx playwright test
          elif [[ "${{ steps.selector.outputs.mode }}" == "stress" ]]; then
            echo "Running full suite in STRESS mode"
            TEST_ENV=${{ steps.selector.outputs.test_env }} THREADS=${{ steps.selector.outputs.threads }} npm run test:all:stress
          else
            if [[ "${{ steps.selector.outputs.use_smoke }}" == "1" ]]; then
              echo "Running smoke suite in one go"
              TEST_ENV=${{ steps.selector.outputs.test_env }} THREADS=${{ steps.selector.outputs.threads }} TAGS="${{ steps.selector.outputs.safe_tags }}" PROJECT= npx playwright test
            else
              echo "Running full suite in SAFE mode"
              TEST_ENV=${{ steps.selector.outputs.test_env }} THREADS=${{ steps.selector.outputs.threads }} SAFE_PAUSE_SECONDS=${{ steps.selector.outputs.safe_pause }} SAFE_TAGS="${{ steps.selector.outputs.safe_tags }}" npm run test:all:safe
            fi
          fi

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: .playwright-report
          include-hidden-files: true
